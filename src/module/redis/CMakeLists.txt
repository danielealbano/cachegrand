set(MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH "${CMAKE_BINARY_DIR}/_modules/redis/autogenerated-commands")
file(MAKE_DIRECTORY ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH})

set(SCAFFOLDING_GENERATOR_DIR "${CMAKE_SOURCE_DIR}/tools/redis-commands-scaffolding-generator")

add_custom_command(
        COMMAND python3
            ${SCAFFOLDING_GENERATOR_DIR}/generate-commands-scaffolding.py
            --commands-json-path "${SCAFFOLDING_GENERATOR_DIR}/commands.json"
            --commands-scaffolding-path "${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}"
        COMMENT "Generate scaffolding for Redis commands in ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}"
        OUTPUT
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_arguments.h
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_callbacks.c
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_callbacks.h
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_contexts.c
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_contexts.h
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_enum.h
            ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_info_map.h
        DEPENDS
            ${SCAFFOLDING_GENERATOR_DIR}/generate-commands-scaffolding.py
            ${SCAFFOLDING_GENERATOR_DIR}/commands.json)

add_library(
        cachegrand-internal-module-redis-autogenerated-commands
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_callbacks.c
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/module_redis_autogenerated_commands_contexts.c)

target_include_directories(
        cachegrand-internal-module-redis-autogenerated-commands
        PUBLIC
        "${CMAKE_CURRENT_SOURCE_DIR}/../.."
        ${DEPS_LIST_INCLUDE_DIRS}
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/commands)

file(GLOB MODULE_REDIS_COMMAND_FILENAMES "command/module_redis_command_*.c")
foreach(MODULE_REDIS_COMMAND_FILENAME ${MODULE_REDIS_COMMAND_FILENAMES})
    get_filename_component(MODULE_REDIS_COMMAND_FILENAME_NO_EXT ${MODULE_REDIS_COMMAND_FILENAME} NAME_WE)
    string(TOUPPER ${MODULE_REDIS_COMMAND_FILENAME_NO_EXT} MODULE_REDIS_COMMAND_FILENAME_NO_EXT)
    target_compile_definitions(
            cachegrand-internal-module-redis-autogenerated-commands
            PUBLIC
            "${MODULE_REDIS_COMMAND_FILENAME_NO_EXT}_CALLBACK_PROVIDED")
endforeach()

list(APPEND DEPS_LIST_INCLUDE_DIRS "${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}")
list(APPEND DEPS_LIST_INCLUDE_DIRS "${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/commands")
list(APPEND DEPS_LIST_LIBRARIES cachegrand-internal-module-redis-autogenerated-commands)

set(DEPS_LIST_INCLUDE_DIRS "${DEPS_LIST_INCLUDE_DIRS}" PARENT_SCOPE)
set(DEPS_LIST_LIBRARIES "${DEPS_LIST_LIBRARIES}" PARENT_SCOPE)
