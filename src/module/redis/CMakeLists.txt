set(MODULE_NAME "redis")
set(SCAFFOLDING_GENERATOR_DIR "${CMAKE_SOURCE_DIR}/tools/redis-commands-scaffolding-generator")

string(REPLACE "_" "-" TARGET_MODULE_NAME ${MODULE_NAME})
set(TARGET_NAME "cachegrand-internal-module-${TARGET_MODULE_NAME}-autogenerated-commands")
set(SCAFFOLDING_FILES_PREFIX "module_${MODULE_NAME}_autogenerated_commands")
set(COMMANDS_JSON_DIR ${CMAKE_CURRENT_SOURCE_DIR})
set(MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH "${CMAKE_BINARY_DIR}/_modules/${MODULE_NAME}/autogenerated-commands")
file(MAKE_DIRECTORY ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH})

add_custom_command(
        COMMAND python3
        ${SCAFFOLDING_GENERATOR_DIR}/generate-commands-scaffolding.py
        --module-name "${MODULE_NAME}"
        --files-prefix "${SCAFFOLDING_FILES_PREFIX}"
        --commands-json-path "${COMMANDS_JSON_DIR}/commands.json"
        --commands-scaffolding-path "${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}"
        COMMENT "Generate scaffolding for Redis commands in ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}"
        OUTPUT
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_arguments.h
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_callbacks.c
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_callbacks.h
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_contexts.c
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_contexts.h
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_enum.h
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_info_map.h
        DEPENDS
        ${SCAFFOLDING_GENERATOR_DIR}/generate-commands-scaffolding.py
        ${COMMANDS_JSON_DIR}/commands.json)

add_library(
        ${TARGET_NAME}
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_callbacks.c
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/${SCAFFOLDING_FILES_PREFIX}_contexts.c)

target_include_directories(
        ${TARGET_NAME}
        PUBLIC
        "${CMAKE_CURRENT_SOURCE_DIR}/../.."
        ${DEPS_LIST_INCLUDE_DIRS}
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}
        ${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/commands)

file(GLOB MODULE_REDIS_COMMAND_FILENAMES "command/module_${MODULE_NAME}_command_*.c")
foreach(MODULE_REDIS_COMMAND_FILENAME ${MODULE_REDIS_COMMAND_FILENAMES})
    get_filename_component(MODULE_REDIS_COMMAND_FILENAME_NO_EXT ${MODULE_REDIS_COMMAND_FILENAME} NAME_WE)
    string(TOUPPER ${MODULE_REDIS_COMMAND_FILENAME_NO_EXT} MODULE_REDIS_COMMAND_FILENAME_NO_EXT)
    target_compile_definitions(
            ${TARGET_NAME}
            PUBLIC
            "${MODULE_REDIS_COMMAND_FILENAME_NO_EXT}_CALLBACK_PROVIDED")
endforeach()

list(APPEND DEPS_LIST_INCLUDE_DIRS "${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}")
list(APPEND DEPS_LIST_INCLUDE_DIRS "${MODULE_REDIS_AUTOGENERATED_COMMANDS_PATH}/commands")
list(APPEND DEPS_LIST_LIBRARIES ${TARGET_NAME})

set(DEPS_LIST_INCLUDE_DIRS "${DEPS_LIST_INCLUDE_DIRS}" PARENT_SCOPE)
set(DEPS_LIST_LIBRARIES "${DEPS_LIST_LIBRARIES}" PARENT_SCOPE)
